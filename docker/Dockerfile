FROM apache/superset:latest

USER root

# å¿…è¦æœ€å°é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    fonts-noto-cjk \
    netcat-openbsd \
    curl \
    git \
    openssh-client \
    && rm -rf /var/lib/apt/lists/*

# requirements.txtã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt && rm /tmp/requirements.txt

# Node.js LTSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆClaude Codeç”¨ï¼‰
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# npmã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
RUN mkdir -p /home/superset/.npm-global \
    && chown -R superset:superset /home/superset/.npm-global

# èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆï¼ˆrootæ¨©é™ã§ï¼‰
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Dev Containerå†…ã‹ã©ã†ã‹ã®åˆ¤å®š\n\
if [ "$VSCODE_INJECTION" = "1" ] || [ -n "$REMOTE_CONTAINERS" ] || [ -n "$CODESPACES" ]; then\n\
    echo "ðŸ”§ Running in Dev Container mode"\n\
    export PYTHONPATH=/workspace/src\n\
    exec sleep infinity\n\
fi\n\
\n\
echo "ðŸš€ Starting production mode"\n\
echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šå¾…æ©Ÿ..."\n\
while ! nc -z postgres 5432; do \n\
    sleep 1\n\
done\n\
\n\
export PYTHONPATH=/workspace/src\n\
\n\
echo "Superset ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ä¸­..."\n\
superset db upgrade\n\
\n\
if ! superset fab list-users | grep -q "admin"; then\n\
    echo "ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆä¸­..."\n\
    superset fab create-admin \\\n\
        --username admin \\\n\
        --firstname Admin \\\n\
        --lastname User \\\n\
        --email admin@example.com \\\n\
        --password admin\n\
fi\n\
\n\
superset init\n\
\n\
echo "å®¶è¨ˆç°¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­..."\n\
cd /workspace\n\
if python -m src.main init; then\n\
    echo "å®¶è¨ˆç°¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†"\n\
else\n\
    echo "Warning: å®¶è¨ˆç°¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Supersetã®ã¿èµ·å‹•ã—ã¾ã™ã€‚"\n\
fi\n\
\n\
echo "Supersetèµ·å‹•ä¸­..."\n\
gunicorn --bind 0.0.0.0:8088 --workers 1 --timeout 60 "superset.app:create_app()"' > /app/start.sh \
    && chmod +x /app/start.sh

USER superset

# npmè¨­å®š
RUN npm config set prefix '/home/superset/.npm-global'
ENV PATH="/home/superset/.npm-global/bin:$PATH"

WORKDIR /workspace
CMD ["/app/start.sh"]