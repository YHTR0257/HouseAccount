FROM apache/superset:latest

USER root

# å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    fonts-noto-cjk \
    netcat-openbsd \
    curl \
    git \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# sudoã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«supersetãƒ¦ãƒ¼ã‚¶ãƒ¼ã«sudoæ¨©é™ã‚’ä»˜ä¸Ž
RUN echo "superset ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/superset \
    && chmod 0440 /etc/sudoers.d/superset

# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --no-cache-dir psycopg2-binary pandas scikit-learn python-dotenv gunicorn

# Node.js LTSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆClaude Codeç”¨ï¼‰
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# npmã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
RUN mkdir -p /home/superset/.npm-global \
    && chown -R superset:superset /home/superset/.npm-global

# èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆï¼ˆrootæ¨©é™ã§ï¼‰
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Dev Containerå†…ã‹ã©ã†ã‹ã®åˆ¤å®š\n\
if [ "$VSCODE_INJECTION" = "1" ] || [ -n "$REMOTE_CONTAINERS" ]; then\n\
    echo "ðŸ”§ Running in Dev Container mode"\n\
    exec sleep infinity\n\
fi\n\
\n\
echo "ðŸš€ Starting production mode"\n\
echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šå¾…æ©Ÿ..."\n\
while ! nc -z postgres 5432; do \n\
    sleep 1\n\
done\n\
\n\
export PYTHONPATH=/workspace/src\n\
\n\
echo "Superset ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ä¸­..."\n\
superset db upgrade\n\
\n\
if ! superset fab list-users | grep -q "admin"; then\n\
    echo "ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆä¸­..."\n\
    superset fab create-admin \\\n\
        --username admin \\\n\
        --firstname Admin \\\n\
        --lastname User \\\n\
        --email admin@example.com \\\n\
        --password admin\n\
fi\n\
\n\
superset init\n\
\n\
echo "å®¶è¨ˆç°¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­..."\n\
cd /workspace\n\
if [ -f "src/main.py" ]; then\n\
    python src/main.py init\n\
else\n\
    echo "Warning: src/main.py not found, skipping household system initialization"\n\
fi\n\
\n\
echo "Supersetèµ·å‹•ä¸­..."\n\
gunicorn --bind 0.0.0.0:8088 --workers 2 --timeout 60 "superset.app:create_app()"' > /app/start.sh \
    && chmod +x /app/start.sh

USER superset

# npmè¨­å®š
RUN npm config set prefix '/home/superset/.npm-global'
ENV PATH="/home/superset/.npm-global/bin:$PATH"

WORKDIR /workspace
CMD ["/app/start.sh"]